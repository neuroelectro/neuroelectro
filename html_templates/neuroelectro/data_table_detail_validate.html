{% extends "neuroelectro/base.html" %}

{% block title %}NeuroElectro :: Data table {{datatable.pk}}{% endblock %}

{% block extracss %}
<style type="text/css">
table, th, td {
	text-align: left;
	border: 1px solid black;
}
.no-box {
    border: 0px solid black;
}
.logo_bar {
	border: 1px solid #eee;
}
.footer_bar {
	border: 1px solid #eee;
}
div#qTip {
	padding: 3px;
	border: 1px solid #666;
	border-right-width: 2px;
	border-bottom-width: 2px;
	display: none;
	background: #999;
	color: #FFF;
	font: bold 9px Verdana, Arial, sans-serif;
	text-align: left;
	position: absolute;
	z-index: 1000;
}
.ninjaText {
	font: bold Verdana, Arial, sans-serif;
	line-height: 16px !important;
	font-size: 14px !important;
	text-align: center;
	vertical-align: top;
	color: white;
}
.ninjaRadial div.nradItem label {
    bottom: 15px;
}
.ui-tooltip {
    background-color: #B4EEB4;
    font-family: Arial, Helvetica, sans-serif;
    width:350px;
    padding:10px;
    border-radius: 5px;
    opacity:0.9;
    z-index: 2;
}
.dropdown_div {
	width: 300px;
	padding: 5px;
	border: 5px solid black;
	margin: 5px;
}
.value_meta {
	width: 284px;
}
.delete-anno {
	position: relative;
	top: -2px;
	left: 233px;
}
.confirm-anno {
	position: relative;
	top: -2px;
	left: 228px;
}
.dropdown {
	width: 300px !important;
}
.neuron_long_name {
	width: 284px;
}
.note {
	width: 284px;
}
.datatable_note {
	width: 600px;
	height: 50px !important;
}
.history {
    float: right;
}
.annotate {
	float: right;
}
.undoRemoval {
	float: left;
}
</style>

{% endblock %}

{% block javascripts %}
<script type="text/javascript">
/* 
Generate Curation Table, inputs:
'datatable': datatable, 
'nedm_list': nedmObs,
'ecm_list': ecmObs,
'ncm_list': ncmObs,
'meta_list': efcmObs,
'ephys_all': m.EphysProp.objects.all(),
'neuron_all': m.Neuron.objects.all(),
'meta_all': dictionary of {metadata name : all possible values} pairs. The possible values list is None for non-categorical metadata
'meta_helper': dictionary of {metadata name : description} pairs. Used in tooltips.
*/
var user = '{{request.user|safe}}';
var ecm_list = '{{ecm_list|safe|escapejs}}', ncm_list = '{{ncm_list|safe|escapejs}}', nedm_list = '{{nedm_list|safe|escapejs}}', meta_list = '{{meta_list|safe|escapejs}}', meta_all = '{{meta_all|safe|escapejs}}';
var meta_values = {};
var metaIndex = 0;

// Create dictionaries to store existing ecm, ncm, nedm and efcm entities
var matchingEphysDTIds = {}, matchingNeuronDTIds = {}, matchingDataValIds = {}, matchingMetaDTIds = {};

// Instantiate the dropdown menus
var ephys_dropdown = $("<select class='ephys_dropdown dropdown' title='Choose the most appropriate electrophysiology property from the list.'/>"), 
	neuron_dropdown = $("<select class='neuron_dropdown dropdown' title='Choose the most appropriate neuron type from the list.'/>"), 
	meta_dropdown = $("<select class='metadata_dropdown dropdown' title='Choose the most appropriate experimental factor from the list.'/>");

/* Define trim() function for Strings - IE special care */
if (!String.prototype.trim) {
    String.prototype.trim = function() {
        return String(this).replace(/^\s+|\s+$/g, '');
    };
}

/* Define indexOf() function for Strings - IE special care */
if (!Array.prototype.indexOf) {
	Array.prototype.indexOf = function(searchElement, fromIndex) {
    	var k;
	    if (this == null) {
	      throw new TypeError('"this" is null or not defined');
	    }
	    var O = Object(this);
	    var len = O.length >>> 0;
	    if (len === 0) {
	      return -1;
	    }
	    var n = +fromIndex || 0;
	    if (Math.abs(n) === Infinity) {
	      n = 0;
	    }
	    if (n >= len) {
	      return -1;
	    }
	    k = Math.max(n >= 0 ? n : len - Math.abs(n), 0);
	    while (k < len) {
	      if (k in O && O[k] === searchElement) {
	        return k;
	      }
	      k++;
	    }
	    return -1;
	};
}

//If there are uncommitted changes - ask before navigating away. From http://stackoverflow.com/questions/1119289
var confirmOnPageExit = function (e) {
    // If we haven't been passed the event get the window.event
    e = e | window.event;

    var message = 'Staged curations have not been committed. Are you sure that you want to navigate away from this page?';

    // For IE6-8 and Firefox prior to version 4
    if (e) {
        e.returnValue = message;
    }

    // For Chrome, Safari, IE8+ and Opera 12+
    return message;
};

/* Check if the text is blank, "None" or whitespace only */
function meaningfulTextExists(text) {
	return text.length > 0 & text != "None" & text.trim().length > 0;
}

/* Test whether the string contains at least one English letter, is not N/A or NA and is not an exponent */
function isASCII(str) {
	return /[a-zA-Z]/.test(str) & !/^NA$|^N\/A$|\d+\w*e[\^\-\d]/gi.test(str);
}

/* Remove a current annotation (function for the X button)) */
function deleteDropdown(btn) {
	var id = $(btn).attr('id');
	if (id.indexOf("_ep_") > -1) {
		var tag_id = id.replace('delete_ep_', '');
		$("#div_ephys_" + tag_id).remove();
	} else if (id.indexOf("_nt_") > -1) {
		var tag_id = id.replace('delete_nt_', '');
		$("#div_neuron_" + tag_id).remove();
	} else if (id.indexOf("_meta_") > -1) {
		var tag_id = id.replace('delete_meta_', '');
		$("#div_meta_" + tag_id).remove();
		var tag_id = tag_id.replace(/_\d+/, '');
	} else {
		alert("Invalid operation requested, please refresh the page. If this error continues - contact the website administrator.");
	}
	
	if ($("#original_colour_" + tag_id).length) {
		$("#" + tag_id).css("background-color", $("#original_colour_" + tag_id).attr("value"));
	} else {
		$("#" + tag_id).css("background-color", "#eee");
	}
}

/* Confirm current annotations and stage them for submission to the server (function for the checkmark button)) */
function confirmAnnotations(btn) {
	window.onbeforeunload = confirmOnPageExit;
	var id = $(btn).attr('id');
	if (id.indexOf("_ep_") > -1) {
		var tag_id = id.replace('confirm_ep_', '');
		
		var ephys_prop = $("#ephys_dropdown_" + tag_id + " option:selected").text();
		var ephys_note = $("#ephys_note_" + tag_id).attr("value");
		
		$("#div_ephys_" + tag_id).remove();
		$("[name='ephys_dropdown_" + tag_id + "']").remove();
		$("[name='ephys_note_" + tag_id + "']").remove();
		
		$("#" + tag_id).append("<input name='ephys_dropdown_" + tag_id + "' type='hidden' value='" + ephys_prop + "'>");
		$("#ep_concept_" + tag_id).text("Staged concept: " + ephys_prop);
		$("#ep_concept_" + tag_id).show();
		
		if (meaningfulTextExists(ephys_note)) {
			$("#" + tag_id).append("<input name='ephys_note_" + tag_id + "' type='hidden' value='" + ephys_note + "'>");
			$("#ep_note_" + tag_id).text("Staged note: " + ephys_note);
			$("#ep_note_" + tag_id).show();
		} else {
			$("#ep_note_" + tag_id).hide();
		}
		
	} else if (id.indexOf("_nt_") > -1) {
		var tag_id = id.replace('confirm_nt_', '');
		
		var neuron_prop = $("#neuron_dropdown_" + tag_id + " option:selected").text();
		var neuron_note = $("#neuron_note_" + tag_id).attr("value");
		var neuron_long_name = $("#neuron_long_name_" + tag_id).attr("value");
		
		$("#div_neuron_" + tag_id).remove();
		$("[name='neuron_dropdown_" + tag_id + "']").remove();
		$("[name='neuron_note_" + tag_id + "']").remove();
		$("[name='neuron_long_name_" + tag_id + "']").remove();
		
		$("#" + tag_id).append("<input name='neuron_dropdown_" + tag_id + "' type='hidden' value='" + neuron_prop + "'>");
		$("#nt_concept_" + tag_id).text("Staged concept: " + neuron_prop);
		$("#nt_concept_" + tag_id).show();
		
		if (meaningfulTextExists(neuron_note)) {
			$("#" + tag_id).append("<input name='neuron_note_" + tag_id + "' type='hidden' value='" + neuron_note + "'>");
			$("#nt_note_" + tag_id).text("Staged note: " + neuron_note);
			$("#nt_note_" + tag_id).show();
		} else {
			$("#nt_note_" + tag_id).hide();
		}
		
		if (meaningfulTextExists(neuron_long_name)) {
			$("#" + tag_id).append("<input name='neuron_long_name_" + tag_id + "' type='hidden' value='" + neuron_long_name + "'>");
			$("#nt_nln_" + tag_id).text("Staged neuron long name: " + neuron_long_name);
			$("#nt_nln_" + tag_id).show();
		} else {
			$("#nt_nln_" + tag_id).hide();
		}
		
	} else if (id.indexOf("_meta_") > -1) {
		var tag_id = id.replace('confirm_meta_', '');
		var tag = tag_id.replace(/_\d+/, '');
		
		var meta_name = $("#meta_dropdown_" + tag_id + " option:selected").text();
		var meta_note = $("#meta_note_" + tag_id).attr("value");
		var meta_value = $("#value_meta_" + tag_id).length ? $("#value_meta_" + tag_id).val() : $("#value_dropdown_" + tag_id + " option:selected").text()
		
		$("#div_meta_" + tag_id).remove();
		
		if ($("[name='meta_dropdown_" + tag + "_" + meta_name + "']").length) {
			$("[name='meta_value_" + tag + "_" + meta_name + "']").attr("value", meta_value);
			$("[name='meta_note_" + tag + "_" + meta_name + "']").attr("value", meta_note);
			
			$("#meta_stage_" + tag + "_" + meta_name).text("Staged meta: " + meta_name + ": " + meta_value);
			$("#meta_stage_note_" + tag + "_" + meta_name).text("Staged note: " + meta_note);
			if (meaningfulTextExists(meta_note)) {
				$("#meta_stage_note_" + tag + "_" + meta_name).show();
			} else {
				$("#meta_stage_note_" + tag + "_" + meta_name).hide();
			}
		} else {
			$("#" + tag).append($("<input name='meta_dropdown_" + tag + "_" + meta_name + "' type='hidden' value='" + meta_name + "'>"));
			$("#" + tag).append($("<input name='meta_value_" + tag + "_" + meta_name + "' type='hidden' value='" + meta_value + "'>"));
			$("#" + tag).append($("<input name='meta_note_" + tag + "_" + meta_name + "' type='hidden' value='" + meta_note + "'>"));
			
			$("#meta_stage_" + tag).append("<div id='meta_stage_" + tag + "_" + meta_name + "'>Staged meta: " + meta_name + ": " + meta_value + "</div>");
			$("#meta_stage_" + tag).append("<div id='meta_stage_note_" + tag + "_" + meta_name + "'>Staged note: " + meta_note + "</div>");
			if (!meaningfulTextExists(meta_note)) {
				$("#meta_stage_note_" + tag + "_" + meta_name).hide();
			}
			$("#meta_stage_" + tag).show();
		}
		
		
		
		if (meaningfulTextExists(meta_note)) {
			
			//$("#meta_entities_" + tag).text($("#meta_entities_" + tag).text() + "\nStaged meta note: " + meta_note + "\n");
		}
		
		tag_id = tag;
	} else {
		alert("An error has occurred while trying to stage an unknown data type. Please contact the website administrator if this issue persists.");
	}
	
	$("#" + tag_id).css("background-color", "#6495ED");
	
	if ($("#original_colour_" + tag_id).length) {
		$("#original_colour_" + tag_id).attr("value", "#6495ED");
	} else {
		$("#" + tag_id).append($("<input type='hidden' id='original_colour_" + tag_id + "' value='#6495ED'>"));
	}
}

// Restore electrophysiology data in this table cell to its original values
function setEphysDefaults(tag_id) {
	if (!matchingEphysDTIds[tag_id]) {
		return;
	}
	
	var ephys_note = matchingEphysDTIds[tag_id]["ephys_note"];
	$("#ep_concept_" + tag_id).text("Concept: " + matchingEphysDTIds[tag_id]["ephys_prop"]);
	$("#ep_concept_" + tag_id).show();
	if (meaningfulTextExists(ephys_note)) { 
		$("#ep_note_" + tag_id).text("Note: " + ephys_note);
		$("#ep_note_" + tag_id).show();
	} else {
		$("#ep_note_" + tag_id).hide();
	}
}


// Restore metadata in this table cell to its original values
function setMetaDefaults(tag_id) {
	if (!matchingMetaDTIds[tag_id]) {
		return;
	}
	
	for (meta in matchingMetaDTIds[tag_id]) {
		var meta_note = meta["meta_note"];
	
		$("#meta_entities_" + tag_id).text($("#meta_entities_" + tag_id).text() + "\n" + meta["meta_name"] + ": " + meta["meta_value"]);
		if (meaningfulTextExists(meta_note)) {
			$("#meta_entities_" + tag_id).text($("#meta_entities_" + tag_id).text() + "\nNote:" + meta_note);
		}
	}
	$("#meta_entities_" + tag_id).show();
}

// Restore neuron data in this table cell to its original values
function setNeuronDefaults(tag_id) {
	if (!matchingNeuronDTIds[tag_id]) {
		return;
	}
	
	var neuron_note = matchingNeuronDTIds[tag_id]["neuron_note"];
	var	neuron_long_name = matchingNeuronDTIds[tag_id]["neuron_long_name"];
		
	$("#nt_concept_" + tag_id).text("Concept: " + matchingNeuronDTIds[tag_id]["neuron_name"]);
	$("#nt_concept_" + tag_id).show();
	
	if (meaningfulTextExists(neuron_note)) {
		$("#nt_note_" + tag_id).text("Note: " + neuron_note);
		$("#nt_note_" + tag_id).show();
	} else {
		$("#nt_note_" + tag_id).hide();
	}
	
	if (meaningfulTextExists(neuron_long_name)) {
		$("#nt_nln_" + tag_id).text("Neuron long name: " + neuron_long_name);
		$("#nt_note_" + tag_id).show();
	} else {
		$("#nt_nln" + tag_id).hide();
	}
}

// Undo the call to schedule this table cell for deletion from database
function removeAnnotationRemoval(tag_id) {
	if ($("[name='delete_" + tag_id + "']").length) {
		$("[name='delete_" + tag_id + "']").remove();
		$("#removeAnnotation_" + tag_id).remove();
		$("#undoRemoval_" + tag_id).remove();
		
		if ($("#original_colour_" + tag_id).length) {
			$("#" + tag_id).css("background-color", $("#original_colour_" + tag_id).attr("value"));
		} else {
			$("#" + tag_id).css("background-color", "#eee");
		}
		
		setEphysDefaults(tag_id);
   		setNeuronDefaults(tag_id);		
		setMetaDefaults(tag_id);
	}
	
	if (document.getElementById("curation_{{datatable.pk}}").innerHTML.indexOf("Staged concept:") == -1) {
		window.onbeforeunload = null;
	}
}

// Wrapper function for the undo removal button
function removeAnnotationRemovalButton(btn) {
	tag_id = $(btn).attr('id').replace('undoRemoval_', '');
	removeAnnotationRemoval(tag_id);
}

$(document).ready(function() {
    // Populate the default dropdown lists for ephys. properties, neuron types and metadata
    {% for ep in ephys_all %}
   		$('<option />', {value :'{{ ep.name }}', text: '{{ ep.name }}'}).appendTo(ephys_dropdown);
    {% endfor %}
    
    {% for nt in neuron_all %}
		$('<option />', {value: '{{ nt.name }}', text: '{{ nt.name }}'}).appendTo(neuron_dropdown);
	{% endfor %}
	
    {% for meta in meta_all %}
		$('<option />', {value: '{{ meta }}', text: '{{ meta }}'}).appendTo(meta_dropdown);

 		{% if meta_all|get_item:meta %}
			// create a dropdown of values for this metadata entity
			meta_values['{{ meta }}'] = $("<select class='metadata_dropdown dropdown' title='Choose the most appropriate value from the list.'/>");
			
			// populate the metadata values dropdown with all the possible choices (if this is a categorical entity)
			{% for value in meta_all|get_item:meta %}
				$('<option />', {value: '{{ value }}', text: '{{ value }}'}).appendTo(meta_values['{{ meta }}']);
			{% endfor %}
		{% endif %}
	{% endfor %}
	
   	/* Make each table cell interactive */
   	// Using up and down arrows after hitting any key in the dropdown will not clear current selection. Pressing enter to select an option and then pressing enter again is treated as form submission request - this breaks the website.
   	$('#curation_{{datatable.pk}}').each(function() {
    	$(this).find('td').each(function() {
    		if (isASCII($(this).text())) { 
    			attachMenu($(this).attr('id'));
    		}
    	});
    	$(this).find('th').each(function() {
    		if (isASCII($(this).text())) {
    			attachMenu($(this).attr('id'));
    		}
    	});
    });

  	function attachMenu(tag_id) {
  		// Techinically, the next line can be removed if reference text is retrieved from the database in python given cell id in the backend after the form has been submitted
  		$('#' + tag_id).append("<input type='hidden' name='ref_text_" + tag_id + "' value='" + $('#' + tag_id).html() + "'>");
  	
  		$('#' + tag_id).append("<a href='javascript:void(0)' id='annotate_" + tag_id + "' title='Annotate this table cell. Select one or more options from the radial menu. To undo staging - remove annotations and then click the undo annotation removal button.' class='btn btn-success annotate'><i class='icon-plus icon-white'></i></a>");
  		$('#' + tag_id).append("<a href='/concept_map_detail/" + {{ datatable.pk }} + "/" + tag_id + "/' id='history_" + tag_id + "' title='View the curation history for this table cell.' class='btn btn-info history fancybox' data-fancybox-type='iframe'><i class='fa fa-clock-o'></i></a>");
  		
   		$("#" + tag_id).append("<div id='ep_concept_" + tag_id + "' style='display: none;'></div>");
		$("#" + tag_id).append("<div id='ep_note_" + tag_id + "' style='display: none;'></div>");
		$("#" + tag_id).append("<div id='nt_concept_" + tag_id + "' style='display: none;'></div>");
		$("#" + tag_id).append("<div id='nt_nln_" + tag_id + "' style='display: none;'></div>");
		$("#" + tag_id).append("<div id='nt_note_" + tag_id + "' style='display: none;'></div>");
		$("#" + tag_id).append("<div id='meta_stage_" + tag_id + "' style='display: none;'></div>");
		$("#" + tag_id).append("<div id='meta_entities_" + tag_id + "' style='display: none;'></div>");
		
  		buttonsModel = [];
  		buttonsModel.push({ text: "Ephys. property", cssLabel: 'ninjaText', title: 'Electrophysiology property', click: function (e) { getEphysDropdown(tag_id);} });
  		buttonsModel.push({ text: "Neuron Type", cssLabel: 'ninjaText', title: 'Neuron Type list from NeuroLex.org', click: function (e) { getNeuronDropdown(tag_id);} });
  		buttonsModel.push({ text: "Remove Annotation", cssLabel: 'ninjaText', title: 'Remove all current and existing in the database curations for this datatable cell', click: function (e) { removeAnnotations(tag_id);} });
  		buttonsModel.push({ text: "Metadata", cssLabel: 'ninjaText', title: 'Experimental factors (metadata)', click: function (e) { getMetadataDropdown(tag_id); }});
  		
  		$('#annotate_' + tag_id).ninjaRadial({
  			buttons: buttonsModel,
  			backColor: "rgba(20,20,20,0.7)",
            borderColor: "rgba(200,200,200,0.1)",
            itemHeight: 40
  		});
	}
  	
	/* For each ncm, ecm, nedm and meta: modify the corresponding table cell accordingly */
	
   	/* Process Ephys. property cells */
   	{% for ecm in ecm_list %}
   		tag_id = '{{ecm.dt_id}}';
   		matchingEphysDTIds[tag_id] = {"ephys_prop" : '{{ ecm.ephys_prop.name }}',
   									  "ephys_note" : '{{ ecm.note }}'};

   		setEphysDefaults(tag_id);

		$("#" + tag_id).css("background-color", "#B2CC80");
		$("#" + tag_id).append($("<input type='hidden' id='original_colour_" + tag_id + "' value='#B2CC80'>"));
	{% endfor %}

	/* Process Neuron Type cells */
	{% for ncm in ncm_list %}
		tag_id = '{{ncm.dt_id}}';
		matchingNeuronDTIds[tag_id] = {"neuron_name" : '{{ ncm.neuron.name }}', 
									   "neuron_long_name" : '{{ ncm.neuron_long_name }}',
									   "neuron_note" : '{{ ncm.note }}'};

		setNeuronDefaults(tag_id);

		$("#" + tag_id).css("background-color", "#E68AB8");
		$("#" + tag_id).append($("<input type='hidden' id='original_colour_" + tag_id + "' value='#E68AB8'>"));
	{% endfor %}

	/* Process nedm (data) cells */
	{% for nedm in nedm_list %}
		tag_id = '{{nedm.dt_id}}';
		matchingDataValIds[tag_id] = null;
		
		$("#" + tag_id).css("background-color", "#E6E600");
		$("#" + tag_id).append($("<input type='hidden' id='original_colour_" + tag_id + "' value='#E6E600'>"));
	{% endfor %}
	
	{% for meta in meta_list %}
		tag_id = '{{meta.dt_id}}';
		meta_value = '{{ meta.metadata.cont_value }}' == null ? '{{ meta.metadata.value }}' : '{{ meta.metadata.cont_value }}'; 
		
		if (!matchingMetaDTIds[tag_id]) { 
			matchingMetaDTIds[tag_id] = [{"meta_name" : '{{ meta.metadata.name }}',
										  "meta_note" : '{{ meta.note }}',
										  "meta_value": meta_value}];
		} else {
			matchingMetaDTIds[tag_id].append({
										  "meta_name" : '{{ meta.metadata.name }}',
										  "meta_note" : '{{ meta.note }}',
										  "meta_value": meta_value});
		}
		
		setMetaDefaults(tag_id);
		
		if ($("#original_colour_" + tag_id).length == 0) {
			$("#" + tag_id).css("background-color", "#FAFAD2");
			$("#" + tag_id).append($("<input type='hidden' id='original_colour_" + tag_id + "' value='#FAFAD2'>"));
		}
	{% endfor %}
	
	/* Remove all annotations from table cell and mark it for deletion from the database */
   	function removeAnnotations(tag_id) {
   		if ($("[name='ephys_dropdown_" + tag_id + "']").length) {
   			$("#div_ephys_" + tag_id).remove();
   			$("[name='ephys_dropdown_" + tag_id + "']").remove();
   			$("[name='ephys_note_" + tag_id + "']").remove();
   			$("#ep_concept_" + tag_id).text("");
   			$("#ep_concept_" + tag_id).hide();
   			$("#ep_note_" + tag_id).text("");
   			$("#ep_note_" + tag_id).hide();
   			$("#meta_stage_" + tag_id).empty();
   			$("#meta_stage_" + tag_id).hide();
   			$("#meta_entities_" + tag_id).empty();
   		}
   		
   		if ($("[name='neuron_dropdown_" + tag_id + "']").length) {
   			$("#div_neuron_" + tag_id).remove();
   			$("[name='neuron_dropdown_" + tag_id + "']").remove();
   			$("[name='neuron_note_" + tag_id + "']").remove();
   			$("[name='neuron_long_name_" + tag_id + "']").remove();
   			$("#nt_concept_" + tag_id).text("");
   			$("#nt_note_" + tag_id).text("");
   			$("#nt_nln_" + tag_id).text("");
   			$("#nt_concept_" + tag_id).hide();
   			$("#nt_note_" + tag_id).hide();
   			$("#nt_nln_" + tag_id).hide();
   			$("#meta_stage_" + tag_id).empty();
   			$("#meta_stage_" + tag_id).hide();
   			$("#meta_entities_" + tag_id).empty();
   		}
   		
   		if ($('#delete_' + tag_id).length == 0) {
   			$('#' + tag_id).append("<input type='hidden' name='delete_" + tag_id + "'>");
   			$('#' + tag_id).append("<input type='text' id='removeAnnotation_" + tag_id + "' title='To undo this action: annotate the cell again by choosing Ephys property or Neuron type option in the radial menu.' value='This cell's annotations will be removed from the Neuroelectro database.");
   			$('#' + tag_id).css("background-color", "#A52A2A");
   	  		$('#' + tag_id).append("<button id='undoRemoval_" + tag_id + "' type='button' onclick='removeAnnotationRemovalButton(this)' title='Undo scheduling the annotations from this cell for deletion from the database.' class='btn btn-success undoRemoval'>Undo annotation removal</a>");
   		}
   	}

  	// Build Ephys annotation fields and attach to current cell
   	function getEphysDropdown(tag_id) {
   		removeAnnotationRemoval(tag_id);

   		if (($("#" + tag_id).find('.ephys_dropdown')).length) {
			alert("This table cell already has an electrophysiology dropdown in it.");
			return
		}
   		
/*    		$("[name='ephys_dropdown_" + tag_id + "']").remove();
   		$("[name='ephys_note_" + tag_id + "']").remove(); */
   		
/*    		if (tag_id in matchingEphysDTIds) {
			setEphysDefaults(tag_id);
   		} else {
   			$("#ep_concept_" + tag_id).hide();
   			$("#ep_note_" + tag_id).hide();
   		} */
   		
		var dropdown = $(ephys_dropdown).clone(true).get(0);
		$(dropdown).attr('id', "ephys_dropdown_" + tag_id);
	
		// TODO: Notes should be larger boxes with vertical scroll available if size was exceeded.
		$("<div id='div_ephys_" + tag_id + "' class='dropdown_div'/>")
			.append($("<button id='confirm_ep_" + tag_id + "' type='button' title='Stage the curations for this cell. They will be stored only in your browser, use the Submit curations to server button to save the annotations in the database.' onclick='confirmAnnotations(this)' class='btn btn-small btn-info confirm-anno'><i class='fa fa-check'></i></button>"))
			.append($("<button id='delete_ep_" + tag_id + "' type='button' title='Remove the ephys. property dropdown and note from this table cell.' onclick='deleteDropdown(this)' class='btn btn-small btn-danger delete-anno'><i class='icon-remove icon-white'></i></button>"))
			.append($("<br/>Ephys. property:<br/>"))
			.append(dropdown)
			.append($("<br/>Ephys. note:<input type='text' id='ephys_note_" + tag_id + "' class='note'>"))
			.appendTo($("#" + tag_id));
		
		/* Attach live list filtering to the dropdown */
		makeDropdownSearchable("ephys_dropdown_" + tag_id);
		
		/* Set the currently existing annotation as the default option (if any) */
		if (tag_id in matchingEphysDTIds) {
			$("select[id='ephys_dropdown_" + tag_id + "'] option:selected").attr("selected", null);
			$("select[id='ephys_dropdown_" + tag_id + "'] option[value='" + matchingEphysDTIds[tag_id]["ephys_prop"] + "']").attr("selected", "selected");
			if (matchingEphysDTIds[tag_id]["ephys_note"] != "None") {
				$("#ephys_note_" + tag_id).attr("value", matchingEphysDTIds[tag_id]["ephys_note"]);
			}
		}
		
		$("#" + tag_id).css("background-color", "#B2CC80");
  	}
  	
 	// Build Neuron annotation fields and attach to current cell
  	function getNeuronDropdown(tag_id) {
  		removeAnnotationRemoval(tag_id);

  		if (($("#" + tag_id).find('.neuron_dropdown')).length) {
			alert("This table cell already has a neuron type dropdown in it.");
			return
		}
		
 /*   		if (tag_id in matchingNeuronDTIds) {
			setNeuronDefaults(tag_id);
   		} else {
   			$("#nt_concept_" + tag_id).hide();
   			$("#nt_note_" + tag_id).hide();
   			$("#nt_nln_" + tag_id).hide();
   		} */
  		
		var dropdown = $(neuron_dropdown).clone(true).get(0);
		$(dropdown).attr('id', "neuron_dropdown_" + tag_id);

		$("<div id='div_neuron_" + tag_id + "' class='dropdown_div'/>")
			.append($("<button id='confirm_nt_" + tag_id + "' type='button' title='Stage the curations for this cell. They will be stored only in your browser, use the Submit curations to server button to save the annotations in the database.' onclick='confirmAnnotations(this)' class='btn btn-small btn-info confirm-anno'><i class='fa fa-check'></i></button>"))
			.append($("<button id='delete_nt_" + tag_id + "' type='button' title='Remove the neuron type dropdown, long name and note from this table cell.' onclick='deleteDropdown(this)' class='btn btn-small btn-danger delete-anno'><i class='icon-remove icon-white'></i></button>"))
			.append($("<br/>Neuron type:<br/>"))
			.append(dropdown)
			.append($("<br/>Neuron Long Name:<input type='text' id='neuron_long_name_" + tag_id + "' class='neuron_long_name'>"))
			.append($("<br/>Neuron note:<br/><input type='text' id='neuron_note_" + tag_id + "' class='note'>"))
			.appendTo("#" + tag_id);
		
		/* Attach live list filtering to the dropdown */
		makeDropdownSearchable("neuron_dropdown_" + tag_id);
		
		/* Set the currently existing annotation as the default option (if any) */
		if (tag_id in matchingNeuronDTIds) {
			$("select[id='neuron_dropdown_" + tag_id + "'] option:selected").attr("selected", null);
			$("select[id='neuron_dropdown_" + tag_id + "'] option[value='" + matchingNeuronDTIds[tag_id]["neuron_name"] + "']").attr("selected", "selected");
			if (matchingNeuronDTIds[tag_id]["neuron_long_name"] != "None") {
				$("#neuron_long_name_" + tag_id).attr("value", matchingNeuronDTIds[tag_id]["neuron_long_name"]);
			}
			if (matchingNeuronDTIds[tag_id]["neuron_note"] != "None") {
				$("#neuron_note_" + tag_id).attr("value", matchingNeuronDTIds[tag_id]["neuron_note"]);
			}
		}
		
		$("#" + tag_id).css("background-color", "#E68AB8");
  	}
 	
  	// Build Metadata annotation fields and attach to current cell
   	function getMetadataDropdown(tag_id) {
   		removeAnnotationRemoval(tag_id);
   		$("#meta_entities_" + tag_id).show();
   		
		var dropdown = $(meta_dropdown).clone(true).get(0);
		$(dropdown).attr('id', "meta_dropdown_" + tag_id + "_" + metaIndex);
		
		// On click - diplay a dropdown of categorical variable choices or a text field
		//var previousVal;
		$(dropdown).change( function() {
			var tag = $(this).attr("id").replace('meta_dropdown_', '');
			$("#value_dropdown_" + tag).remove();
			$("#value_meta_" + tag).remove();
			var selectedVal = $(this).find(':selected').val();
			
 			if (meta_values[selectedVal]) {
				var valDropdown = meta_values[selectedVal].clone(true).get(0);
				$(valDropdown).attr('id', "value_dropdown_" + tag);
				$(valDropdown).insertAfter("#meta_dropdown_" + tag);
				makeDropdownSearchable("value_dropdown_" + tag);
			} else {
				$("<input type='text' id='value_meta_" + tag + "' class='value_meta'>").insertAfter("#meta_dropdown_" + tag);
			}
			
			// Update all other dropdowns in the same cell to not display the selected metadata - this avoids duplication issues
/* 			var i = 0;
			while($("[name='meta_dropdown_" + tag_id + "_" + i + "']").length > 0) {
				// TODO: implement this through filtering out the currently selected value and adding back the previously selected value into all other dropdowns in this cell.
				i++;
			} */
			
			//previousVal = selectedVal;
		});
	
		// TODO: Notes should be larger boxes with vertical scroll available if size was exceeded.
		$("<div id='div_meta_" + tag_id + "_" + metaIndex + "' class='dropdown_div meta_div'/>")
			.append($("<button id='confirm_meta_" + tag_id + "_" + metaIndex + "' type='button' title='Stage the curations for this cell. They will be stored only in your browser, use the Submit curations to server button to save the annotations in the database.' onclick='confirmAnnotations(this)' class='btn btn-small btn-info confirm-anno'><i class='fa fa-check'></i></button>"))
			.append($("<button id='delete_meta_" + tag_id + "_" + metaIndex + "' type='button' title='Remove the metadata dropdown and note from this table cell.' onclick='deleteDropdown(this)' class='btn btn-small btn-danger delete-anno'><i class='icon-remove icon-white'></i></button>"))
			.append($("<br/>Metadata:<br/>"))
			.append(dropdown)
			.append($("<br/>Metadata note:<input type='text' id='meta_note_" + tag_id + "_" + metaIndex + "' class='note'>"))
			.appendTo($("#meta_entities_" + tag_id));
		
		var selectedVal = $(dropdown).find(':selected').val();
		if (meta_values[selectedVal]) {
			var valDropdown = meta_values[selectedVal].clone(true).get(0);
			$(valDropdown).attr('id', "value_dropdown_" + tag_id + "_" + metaIndex);
			$(valDropdown).insertAfter("#meta_dropdown_" + tag_id + "_" + metaIndex);
			makeDropdownSearchable("value_dropdown_" + tag_id);
		} else {
			$("<input type='text' id='value_meta_" + tag_id + "_" + metaIndex + "' class='value_meta'>").insertAfter("#meta_dropdown_" + tag_id + "_" + metaIndex);
		}
		/* Set the currently existing annotation as the default option (if any) */
/* 		if (tag_id in matchingMetaDTIds) {
			$("select[name='meta_dropdown_" + tag_id + "'] option:selected").attr("selected", null);
			$("select[name='meta_dropdown_" + tag_id + "'] option[value='" + matchingMetaDTIds[tag_id][0]["meta_name"] + "']").attr("selected", "selected");
			if (matchingEphysDTIds[tag_id][0]["meta_note"] != "None") {
				$("[name='meta_note_" + tag_id + "']").attr("value", matchingMetaDTIds[tag_id][0]["meta_note"]);
			}
		} */
		
		makeDropdownSearchable("meta_dropdown_" + tag_id + "_" + metaIndex);
		
		console.log(metaIndex);
		
		metaIndex++;
		
		console.log(metaIndex);
		
		if ($("#original_colour_" + tag_id).length == 0) {
			$("#" + tag_id).css("background-color", "#FAFAD2");
		}
  	}
 	
 	// Override curation form submission function - send back a dictionary of name: value pairs in a POST request (only fields that have a 'name' attribute within the curation form will be included)
  	$("#curation_{{datatable.pk}}").submit(function(e) {
  		window.onbeforeunload = null;
		$("#curation_{{datatable.pk}}").submit();
  		//e.preventDefault();
  		/*var form = $(this);
  		$.ajax({
  			url	   : form.attr('action'),
  			type   : form.attr('method'),
  			data   : form.serialize(),
  			success: function(response) {
  				//window.location.reload(true);
  			}
  		});*/
		window.location.reload(true);
  		return false;
  	});
  	
	/* Attach live list filtering to the dropdowns */
	function makeDropdownSearchable(dropdown_name) {
		$("#" + dropdown_name).searchable({
	        maxListSize: 1000,                      // if list size is less than maxListSize, show them all
	        maxMultiMatch: 500,                     // how many matching entries should be displayed
	        exactMatch: false,                      // Exact matching on search
	        wildcards: true,                        // Support for wildcard characters (*, ?)
	        ignoreCase: true,                       // Ignore case sensitivity
	        latency: 200,                           // how many millis to wait until starting search
	        warnMultiMatch: 'Top {0} matches ...',  // string to append to a list of entries cut short by maxMultiMatch
	        warnNoMatch: 'No matches ...',          // string to show in the list when no entries match
	        zIndex: 'auto'                          // zIndex for elements generated by this plugin
	    });
	}
  	
  	// Add tooltips to all page html objects that contain their title attribute text
    $("#content").tooltip({
        track: true,
        show: {
        	delay: 1500,
        	effect: "slideDown"
        },
        position: { my: "left+15 center", at: "right center" },
        content: function() {
            return $(this).attr('title');
     	}
    });
	  	
	$(".fancybox").fancybox();
	
    $('#neuron_ephys_table').dataTable({
        "iDisplayLength": 50
    }); 
});
</script>
{% endblock %}

{% block content %}
{% include "neuroelectro/article_title_header.html" with article=datatable.article %}

<p>Below is the rendering of the article data table as stored on our server. </p>
<!--  Create the curation table here -->
<form action="{% url "neuroelectro.views.data_table_detail" datatable.pk %}" id="curation_{{datatable.pk}}" method="POST">
	<input type="hidden" name="curation_form_name" value="curation_{{datatable.pk}}">
	{% csrf_token %}
	{{enriched_html_table|safe}}
	<br/>
	<div title='Check this box if the table has already been curated and you have double-checked all the annotations.' style='font-size: 120%'><input type="checkbox" name="validate_all" value="validate_all"/> 
       Validate all mappings in table
	</div>
    <br/>
    <div title="This will delete all existing annotations for this table from the database, check only if the table should not be curated at all. (Use with caution)" style='font-size: 120%'><input type="checkbox" name="remove_all" value="remove_all" /> 
       Remove all mappings in table
    <br/>
    </div>
    <div title='Check this box if table should not be curated and removed from listing of articles to curate. Please add a note' style='font-size: 120%'>
	    {% if datatable.irrelevant_flag %}
	        <input type="checkbox" name="irrelevant_flag" value="irrelevant_flag" checked/>
	    {% else %}
	        <input type="checkbox" name="irrelevant_flag" value="irrelevant_flag"/>
	    {% endif %}
	       Table does not contain relevant electrophysiological data
    </div>
    <br/>
    <div title='Check this box you need help curating the neuron types in this table. Please add a note' style='font-size: 120%'>
	    {% if datatable.complex_neurons %}
	        <input type="checkbox" name="complex_neurons" value="complex_neurons" checked/>
	    {% else %}
	        <input type="checkbox" name="complex_neurons" value="complex_neurons"/>
	    {% endif %}
	       Neuron types need expert review
    </div>
    <div title='Check this box if the table needs to be reviewed by a NeuroElectro admin. Please add a note' style='font-size: 120%'>
	    {% if datatable.needs_expert %}
	        <input type="checkbox" name="expert" value="needs_expert" checked/>
	    {% else %}
	        <input type="checkbox" name="expert" value="needs_expert"/>
	    {% endif %}
	       Table needs admin review
    </div>
    <div title='Write down any thoughts that would be helpful for other curators and users.' style='font-size: 120%'>
	    {% if datatable.note %}
	        <br/>Add Note: <input type="text" name="data_table_note" class='datatable_note' value= "{{data_table_note}}" />
	    {% else %}
	        <br/>Add Note: <input type="text" name="data_table_note" class='datatable_note' value=""/>
	    {% endif %}
    </div>
    <br/>
	<input type="submit" class='btn btn-large btn-info' title='Send all the active annotations and checked boxes to the NeuroElectro server. If you navigate away from the page without doing this the annotations will be lost.' value="Submit curations to server">
</form>

<br/>
<hr/>
<br/>

 <div style="text-align:left">
 <a class="fancybox btn btn-small btn-danger submit_button" data-fancybox-type="iframe" href="/nedm_comment_box/"><i class="icon-thumbs-down icon-white"></i> Report miscurated data</i></a>
 </div>

{% include "neuroelectro/neuron_ephys_data_table_article.html" %}

{% endblock %}

